From 0934d640456bb168a8888ae388643c5160afe501 Mon Sep 17 00:00:00 2001
From: drh <drh@noemail.net>
Date: Mon, 25 May 2020 15:19:52 +0000
Subject: [PATCH] Defensive code that tries to prevent a recurrence of problems
 like the one described in ticket [7a5279a25c57adf1]

FossilOrigin-Name: 572105de1d44bca4f18c99d373458889163611384eebbc9659474874ee1701f4
---
 manifest      | 12 ++++++------
 manifest.uuid |  2 +-
 src/expr.c    | 10 ++++++++--
 3 files changed, 15 insertions(+), 9 deletions(-)

--- a/src/expr.c
+++ b/src/expr.c
@@ -3777,7 +3777,10 @@ expr_code_doover:
   switch( op ){
     case TK_AGG_COLUMN: {
       AggInfo *pAggInfo = pExpr->pAggInfo;
-      struct AggInfo_col *pCol = &pAggInfo->aCol[pExpr->iAgg];
+      struct AggInfo_col *pCol;
+      assert( pAggInfo!=0 );
+      assert( pExpr->iAgg>=0 && pExpr->iAgg<pAggInfo->nColumn );
+      pCol = &pAggInfo->aCol[pExpr->iAgg];
       if( !pAggInfo->directMode ){
         assert( pCol->iMem>0 );
         return pCol->iMem;
@@ -4071,7 +4074,10 @@ expr_code_doover:
     }
     case TK_AGG_FUNCTION: {
       AggInfo *pInfo = pExpr->pAggInfo;
-      if( pInfo==0 ){
+      if( pInfo==0
+       || NEVER(pExpr->iAgg<0)
+       || NEVER(pExpr->iAgg>=pInfo->nFunc)
+      ){
         assert( !ExprHasProperty(pExpr, EP_IntValue) );
         sqlite3ErrorMsg(pParse, "misuse of aggregate: %s()", pExpr->u.zToken);
       }else{
